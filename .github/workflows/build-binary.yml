# 工作流名称：编译BookBrowser纯Go可执行程序
name: Build BookBrowser Go Binary

# 触发条件：main分支push/PR、手动触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 手动触发

# 编译任务
jobs:
  build:
    runs-on: ubuntu-latest
    # 支持多平台编译（匹配alpine的linux/amd64架构）
    strategy:
      matrix:
        goos: [linux]
        goarch: [amd64, arm64]

    steps:
      # 步骤1：拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：安装Go 1.13环境（完全匹配Dockerfile的golang:1.13-alpine）
      - name: Set up Go 1.13
        uses: actions/setup-go@v5
        with:
          go-version: '1.13' # Strictly match Dockerfile's Go version
          cache: true        # Cache go mod dependencies for faster builds

      # 步骤3：安装git（匹配Dockerfile中的apk add git）
      - name: Install git (match Dockerfile)
        run: |
          sudo apt-get update
          sudo apt-get install -y git

      # 步骤4：执行Go编译（完全复刻Dockerfile的编译流程）
      - name: Build Go binary (match Dockerfile)
        run: |
          # Replicate Dockerfile environment and commands
          export CGO_ENABLED=0  # Disable CGO (matches alpine environment)
          export GOOS=${{ matrix.goos }}
          export GOARCH=${{ matrix.goarch }}
          export GO111MODULE=on # Enable modules for Go 1.13

          # 1. Download dependencies (matches Dockerfile: go mod download)
          go mod download

          # 2. Build the program (matches Dockerfile: go build .)
          # Output filename matches Dockerfile (BookBrowser) with platform suffix
          go build -o BookBrowser-${{ matrix.goos }}-${{ matrix.goarch }} \
            -ldflags="-s -w" \
            .

          # Verify build artifact
          ls -lh BookBrowser-${{ matrix.goos }}-${{ matrix.goarch }}
          file BookBrowser-${{ matrix.goos }}-${{ matrix.goarch }} # Check file type (static binary)

      # 步骤5：上传编译产物（供下载使用）
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: BookBrowser-${{ matrix.goos }}-${{ matrix.goarch }}
          path: BookBrowser-${{ matrix.goos }}-${{ matrix.goarch }}
          retention-days: 30 # Keep artifacts for 30 days
